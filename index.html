<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HomeC</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA9Wtvvo1idJB2lXCfwBckgk2hrDbSXOfI",
  authDomain: "homec-e6227.firebaseapp.com",
  databaseURL: "https://homec-e6227-default-rtdb.firebaseio.com",
  projectId: "homec-e6227",
  storageBucket: "homec-e6227.firebasestorage.app",
  messagingSenderId: "55229004317",
  appId: "1:55229004317:web:9495e508539d364f68e4f4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<style>
body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,sans-serif;
height:100vh;
display:flex;
flex-direction:column;
background:#ffffff;
}

.header{
padding:18px;
font-size:22px;
font-weight:bold;
}

.topLine{
display:flex;
justify-content:flex-end;
align-items:center;
border-bottom:1px solid #ddd;
padding:12px 18px;
}

.iconBtn{
margin-left:18px;
font-size:22px;
cursor:pointer;
}

.sectionTitle{
padding:15px 18px;
font-size:17px;
font-weight:bold;
color:#444;
}

#contactList{
flex:1;
overflow-y:auto;
}

.contact{
padding:15px 18px;
border-bottom:1px solid #eee;
cursor:pointer;
transition:0.2s;
}

.contact:hover{
background:#f5f5f5;
}

.contactName{
font-weight:bold;
}

.contactLast{
font-size:13px;
color:gray;
margin-top:4px;
}

#chatScreen{
display:none;
flex-direction:column;
height:100%;
}

.chatHeader{
display:flex;
align-items:center;
padding:12px 15px;
border-bottom:1px solid #ddd;
font-weight:bold;
}

.backBtn{
margin-right:15px;
cursor:pointer;
font-size:18px;
}

#chatBox{
flex:1;
overflow-y:auto;
padding:15px;
display:flex;
flex-direction:column;
background:#f7f7f7;
}

.msg{
padding:10px 14px;
border-radius:18px;
margin-bottom:8px;
max-width:70%;
font-size:14px;
display:flex;
flex-direction:column;
}

.sent{
background:#007bff;
color:white;
align-self:flex-end;
}

.received{
background:#e5e5ea;
align-self:flex-start;
}

.msgTime{
font-size:11px;
margin-top:4px;
opacity:0.7;
}

.inputArea{
display:flex;
padding:12px;
border-top:1px solid #ddd;
background:white;
}

.inputArea input{
flex:1;
padding:12px;
border-radius:20px;
border:1px solid #ccc;
}

.inputArea button{
margin-left:8px;
padding:10px 16px;
border:none;
border-radius:20px;
background:#007bff;
color:white;
}
</style>
</head>

<body>

<div class="header">HomeC</div>

<div class="topLine">
<span class="iconBtn" onclick="addContact()">➕</span>
</div>

<div class="sectionTitle">Contacts</div>

<div id="contactList"></div>

<div id="chatScreen">

<div class="chatHeader">
<span class="backBtn" onclick="backToList()">⬅</span>
<span id="chatUser"></span>
</div>

<div id="chatBox"></div>

<div class="inputArea">
<input id="messageInput" placeholder="Type message">
<button onclick="sendMessage()">Send</button>
</div>

</div>

<script>
let currentUser = localStorage.getItem("loggedInUser");
if(!currentUser){ location.href="auth.html"; }

function addContact(){
let user = prompt("Enter username:");
if(!user) return;

db.ref("contacts/"+currentUser+"/"+user).set(true);
db.ref("contacts/"+user+"/"+currentUser).set(true);
}

function loadContacts(){
db.ref("contacts/"+currentUser).on("value",snap=>{
contactList.innerHTML="";
snap.forEach(c=>{
let name=c.key;

let div=document.createElement("div");
div.className="contact";
div.onclick=()=>openChat(name);

let nameDiv=document.createElement("div");
nameDiv.className="contactName";
nameDiv.innerText=name;

let lastDiv=document.createElement("div");
lastDiv.className="contactLast";

let key=[currentUser,name].sort().join("_");

db.ref("chats/"+key).limitToLast(1).on("value",m=>{
m.forEach(msg=>{
lastDiv.innerText=msg.val().text;
});
});

div.appendChild(nameDiv);
div.appendChild(lastDiv);
contactList.appendChild(div);
});
});
}

let chattingWith=null;

function openChat(user){
chattingWith=user;
chatUser.innerText=user;
document.querySelector(".sectionTitle").style.display="none";
contactList.style.display="none";
chatScreen.style.display="flex";
listen();
}

function backToList(){
chatScreen.style.display="none";
contactList.style.display="block";
document.querySelector(".sectionTitle").style.display="block";
}

function sendMessage(){
let text = messageInput.value.trim();
if(!text) return;

let key=[currentUser,chattingWith].sort().join("_");

db.ref("chats/"+key).push({
sender:currentUser,
text:text,
time: Date.now()
});

messageInput.value="";
}

function listen(){
let key=[currentUser,chattingWith].sort().join("_");

db.ref("chats/"+key).on("value",snap=>{
chatBox.innerHTML="";

snap.forEach(m=>{
let data=m.val();

let d=document.createElement("div");
d.classList.add("msg");
d.classList.add(data.sender===currentUser?"sent":"received");

let textDiv=document.createElement("div");
textDiv.innerText=data.text;

let timeDiv=document.createElement("div");
timeDiv.className="msgTime";

let date=new Date(data.time);
let hours=date.getHours();
let minutes=date.getMinutes();
let ampm=hours>=12?"PM":"AM";
hours=hours%12;
hours=hours?hours:12;
minutes=minutes<10?"0"+minutes:minutes;

timeDiv.innerText=hours+":"+minutes+" "+ampm;

d.appendChild(textDiv);
d.appendChild(timeDiv);

chatBox.appendChild(d);
});

chatBox.scrollTop=chatBox.scrollHeight;
});
}

loadContacts();
</script>

</body>
</html>